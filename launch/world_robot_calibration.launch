<launch>
  <!--
    一键世界-机器人标定（无需旧版手眼标定）：
    - 世界系由 id=0、边长 80mm 的平面 ArUco 定义（world -> camera TF 持续由 world_tag_node 发布）
    - 机械臂末端法兰 +Z 方向 77mm 处固定一枚五面正方体标签，用于视觉观测末端位姿
    - 通过多尺寸 ArUco 检测 + 世界板滤波 + 多面融合，建立 world 与末端之间的闭环观测
    - 步骤：
        1) roslaunch jaka_close_contro world_robot_calibration.launch
        2) 手动移动机器人，使末端正方体在多个姿态下保持在相机视野
        3) 多次调用 /collect_world_robot_sample 采集样本
        4) 调用 /solve_world_robot_calibration 求解 world -> robot_base，并按日志提示固化静态 TF
  -->

  <arg name="ip" default="192.168.1.100" />
  <arg name="urdf_file" default="$(find jaka_close_contro)/urdf/jaka_zu3.urdf" />

  <!-- 0. 启动 JAKA 驱动 + robot_state_publisher，提供关节与 TF 树 -->
  <include file="$(find jaka_close_contro)/launch/jaka_sdk_bringup.launch">
    <arg name="ip" value="$(arg ip)" />
    <arg name="urdf_file" value="$(arg urdf_file)" />
  </include>

  <!-- 1. 启动 ZED2i 相机 -->
  <include file="$(find zed_wrapper)/launch/zed2i.launch">
    <arg name="svo_file" value="" />
  </include>

  <!-- 2. 多尺寸 ArUco 检测器：输出 /fiducial_transforms -->
  <node pkg="jaka_close_contro"
        type="cube_aruco_detector_node"
        name="cube_aruco_detector"
        output="screen">
    <param name="image_topic"       value="/zed2i/zed_node/left/image_rect_color"/>
    <param name="camera_info_topic" value="/zed2i/zed_node/left/camera_info"/>
    <param name="fiducial_topic"    value="/fiducial_transforms"/>
    <param name="default_marker_size" value="0.04"/>
    <rosparam param="marker_sizes">
      "0": 0.08  <!-- World Tag (80mm) -->
      "10": 0.04 <!-- Cube face 1 (40mm) -->
      "11": 0.04 <!-- Cube face 2 -->
      "12": 0.04 <!-- Cube face 3 -->
      "13": 0.04 <!-- Cube face 4 -->
    </rosparam>
  </node>

  <!-- 3. 话题分流：分离世界标记与工具端标记 -->
  <node pkg="jaka_close_contro"
        type="fiducial_relay_node"
        name="fiducial_relay"
        output="screen">
    <param name="world_id"   value="0"/>
    <rosparam param="tool_ids">["10", "11", "12", "13"]</rosparam>
    <param name="input_topic" value="/fiducial_transforms"/>
    <param name="world_topic" value="/world_fiducials"/>
    <param name="tool_topic"  value="/tool_fiducials"/>
  </node>

  <!-- 4. 世界坐标系定义：平滑 world -> camera TF -->
  <node pkg="jaka_close_contro"
        type="world_tag_node"
        name="world_tag_node"
        output="screen">
    <param name="world_fiducial_id" value="0"/>
    <param name="fiducial_topic"    value="/world_fiducials"/>
    <param name="world_frame"       value="world"/>
    <param name="camera_frame"      value="zed2i_left_camera_optical_frame"/>
    <param name="alpha_pos"         value="0.3"/>
    <param name="alpha_rot"         value="0.3"/>
  </node>

  <!-- 5. 末端正方体多面融合，输出 /cube_center_fused -->
  <node pkg="jaka_close_contro"
        type="cube_multi_face_fusion_node"
        name="cube_multi_face_fusion"
        output="screen">
    <param name="faces_yaml"             value="$(find jaka_close_contro)/config/cube_faces_current.yaml"/>
    <param name="fiducial_topic"         value="/tool_fiducials"/>
    <param name="cube_frame"             value="cube_center"/>
    <param name="camera_frame_default"   value="zed2i_left_camera_optical_frame"/>
    <param name="alpha_pos"              value="0.3"/>
    <param name="alpha_rot"              value="0.3"/>
    <param name="max_step_pos"           value="0.03"/>
    <param name="max_step_deg"           value="15.0"/>
    <param name="timeout_sec"            value="0.5"/>
    <param name="publish_tool_tf"        value="false"/>
  </node>

  <!-- 6. 世界-机器人标定节点（直接估计 world -> robot_base） -->
  <node pkg="jaka_close_contro"
        type="world_robot_calibration_node"
        name="world_robot_calibration_node"
        output="screen">
    <param name="world_frame"       value="world" />
    <param name="robot_base_frame"  value="Link_0" />
    <param name="tool_frame"        value="Link_6" />
    <param name="camera_frame"      value="zed2i_left_camera_optical_frame" />
    <param name="cube_frame"        value="cube_center" />
    <param name="cube_offset_z_m"   value="0.077" />
    <param name="min_samples"       value="10" />
    <param name="publish_tf"        value="false" />
  </node>
</launch>
