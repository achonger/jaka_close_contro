<launch>
  <!-- 参数：机器人 IP 与 URDF 路径 -->
  <arg name="ip" default="192.168.1.100" />
  <arg name="urdf_file" default="$(find jaka_close_contro)/urdf/jaka_zu3.urdf" />

  <!-- 0. 启动机器人驱动与 TF 链 -->
  <include file="$(find jaka_close_contro)/launch/jaka_sdk_bringup.launch">
    <arg name="ip" value="$(arg ip)" />
    <arg name="urdf_file" value="$(arg urdf_file)" />
  </include>

  <!-- 1. ZED2i 相机 -->
  <include file="$(find zed_wrapper)/launch/zed2i.launch">
    <arg name="svo_file" value="" />
  </include>

  <!-- 2. 多尺寸 ArUco 检测器 -->
  <node pkg="jaka_close_contro" type="cube_aruco_detector_node" name="cube_aruco_detector" output="screen">
    <param name="image_topic" value="/zed2i/zed_node/left/image_rect_color" />
    <param name="camera_info_topic" value="/zed2i/zed_node/left/camera_info" />
    <param name="fiducial_topic" value="/fiducial_transforms" />
    <param name="default_marker_size" value="0.04" />
    <param name="dictionary" value="DICT_4X4_50" />
    <rosparam param="marker_sizes">
      "0": 0.08
      "10": 0.04
      "11": 0.04
      "12": 0.04
      "13": 0.04
    </rosparam>
  </node>

  <!-- 3. 分流世界板与工具端 fiducial -->
  <node pkg="jaka_close_contro" type="fiducial_relay_node" name="fiducial_relay" output="screen">
    <param name="input_topic" value="/fiducial_transforms" />
    <param name="world_topic" value="/world_fiducials" />
    <param name="tool_topic" value="/tool_fiducials" />
    <param name="world_id" value="0" />
    <rosparam param="tool_ids">["10", "11", "12", "13"]</rosparam>
  </node>

  <!-- 4. 世界坐标系定义 world -> camera -->
  <node pkg="jaka_close_contro" type="world_tag_node" name="world_tag_node" output="screen">
    <param name="fiducial_topic" value="/world_fiducials" />
    <param name="world_frame" value="world" />
    <param name="camera_frame" value="zed2i_left_camera_optical_frame" />
    <param name="alpha_pos" value="0.3" />
    <param name="alpha_rot" value="0.3" />
  </node>

  <!-- 5. 末端正方体多面融合（仅发布 camera->cube_center，关闭视觉末端 TF） -->
  <node pkg="jaka_close_contro" type="cube_multi_face_fusion_node" name="cube_multi_face_fusion" output="screen">
    <param name="faces_yaml" value="$(find jaka_close_contro)/config/cube_faces_current.yaml" />
    <param name="tool_offset_yaml" value="$(find jaka_close_contro)/config/tool_offset_current.yaml" />
    <param name="fiducial_topic" value="/tool_fiducials" />
    <param name="cube_frame" value="cube_center" />
    <param name="camera_frame_default" value="zed2i_left_camera_optical_frame" />
    <param name="alpha_pos" value="0.3" />
    <param name="alpha_rot" value="0.3" />
    <param name="max_step_pos" value="0.05" />
    <param name="max_step_deg" value="30.0" />
    <param name="timeout_sec" value="0.5" />
    <param name="publish_frequency" value="30.0" />
    <param name="publish_tool_tf" value="false" />
  </node>

  <!-- 6. 世界-机器人外参发布器（读取 config/world_robot_extrinsic.yaml） -->
  <node pkg="jaka_close_contro"
        type="world_robot_extrinsic_broadcaster_node"
        name="world_robot_extrinsic_broadcaster"
        output="screen">
    <param name="extrinsic_yaml" value="$(find jaka_close_contro)/config/world_robot_extrinsic.yaml" />
  </node>

  <!-- 7. 世界系闭环控制/观测节点，持续打印 world 下 cube 位姿 -->
  <node pkg="jaka_close_contro" type="cube_world_closedloop_node" name="cube_world_closedloop" output="screen">
    <param name="world_frame" value="world" />
    <param name="cube_frame" value="cube_center" />
    <param name="camera_frame" value="zed2i_left_camera_optical_frame" />
    <param name="robot_base_frame" value="Link_0" />
    <param name="tool_frame" value="Link_6" />
    <param name="tool_offset_yaml" value="$(find jaka_close_contro)/config/tool_offset_current.yaml" />
    <!-- 如需设定目标位姿，可在此添加 target_world_* 参数 -->
  </node>
</launch>
