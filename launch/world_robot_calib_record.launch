<launch>
  <!-- 0. JAKA 驱动与 URDF TF -->
  <arg name="ip" default="192.168.1.100" />
  <arg name="urdf_file" default="$(find jaka_close_contro)/urdf/jaka_zu3.urdf" />

  <include file="$(find jaka_close_contro)/launch/jaka_sdk_bringup.launch">
    <arg name="ip" value="$(arg ip)" />
    <arg name="urdf_file" value="$(arg urdf_file)" />
  </include>

  <!-- 1. ZED2i 相机 -->
  <include file="$(find zed_wrapper)/launch/zed2i.launch">
    <arg name="svo_file" value="" />
  </include>

  <!-- 2. 棱方体检测与融合管线 -->
  <node pkg="jaka_close_contro"
        type="cube_aruco_detector_node"
        name="cube_aruco_detector"
        output="screen">
    <param name="image_topic"       value="/zed2i/zed_node/left/image_rect_color"/>
    <param name="camera_info_topic" value="/zed2i/zed_node/left/camera_info"/>
    <param name="fiducial_topic"    value="/fiducial_transforms"/>
    <param name="default_marker_size" value="0.08"/>
    <param name="dictionary" value="DICT_4X4_50"/>
    <param name="tool_dictionary" value="DICT_6X6_1000"/>
    <param name="tool_marker_length_m" value="0.0425"/>
    <param name="tool_marker_separation_m" value="0.005"/>
    <param name="min_gridboard_markers" value="2"/>
    <param name="world_board_enable" value="true"/>
    <param name="world_board_output_id" value="500"/>
    <param name="world_board_marker_length_m" value="0.0525"/>
    <param name="world_board_marker_separation_m" value="0.005"/>
    <param name="world_board_min_markers" value="2"/>
    <param name="enable_single_world_markers" value="false"/>
    <rosparam param="marker_sizes">
      "0": 0.08  <!-- World Tag (80mm) -->
    </rosparam>
    <rosparam param="world_board_marker_ids">[500, 501, 502, 503]</rosparam>
    <rosparam param="tool_gridboards">
      "10": [0, 1, 2, 3]
      "11": [10, 11, 12, 13]
      "12": [20, 21, 22, 23]
      "13": [30, 31, 32, 33]
    </rosparam>
  </node>

  <node pkg="jaka_close_contro"
        type="fiducial_relay_node"
        name="fiducial_relay"
        output="screen">
    <param name="world_id"   value="500"/>
    <rosparam param="tool_ids">["10", "11", "12", "13"]</rosparam>
    <param name="input_topic" value="/fiducial_transforms"/>
    <param name="world_topic" value="/world_fiducials"/>
    <param name="tool_topic"  value="/tool_fiducials"/>
  </node>

  <node pkg="jaka_close_contro"
        type="world_tag_node"
        name="world_tag_node"
        output="screen">
    <param name="world_fiducial_id" value="500"/>
    <param name="fiducial_topic"    value="/world_fiducials"/>
    <param name="world_frame"       value="world"/>
    <param name="camera_frame"      value="zed2i_left_camera_optical_frame"/>
    <param name="alpha_pos"         value="0.3"/>
    <param name="alpha_rot"         value="0.3"/>
  </node>

  <node pkg="jaka_close_contro"
        type="cube_multi_face_fusion_node"
        name="cube_multi_face_fusion"
        output="screen">
    <param name="faces_yaml"             value="$(find jaka_close_contro)/config/cube_faces_current.yaml"/>
    <param name="fiducial_topic"         value="/tool_fiducials"/>
    <param name="cube_frame"             value="cube_center"/>
    <param name="camera_frame_default"   value="zed2i_left_camera_optical_frame"/>
    <param name="timeout_sec"            value="0.5"/>
  </node>

  <!-- 3. 记录模式：执行标定位姿并写入数据集 -->
  <node pkg="jaka_close_contro"
        type="world_robot_calib_recorder_node"
        name="world_robot_calib_recorder"
        output="screen">
    <param name="arm_name"         value="jaka1" />
    <param name="calib_pose_csv"   value="$(find jaka_close_contro)/config/jaka1_world_robot_calibration_pose.csv" />
    <param name="speed_scale" value="0.15" />
    <param name="linear_speed_mm_s" value="80.0" />
    <param name="linear_acc_mm_s2" value="200.0" />
    <param name="wait_before_sample_sec" value="5.0" />
    <param name="wait_after_sample_sec"  value="2.0" />
    <param name="sample_duration_sec" value="2.0" />
    <param name="tf_lookup_timeout_sec" value="0.1" />
    <param name="world_frame" value="world" />
    <param name="camera_frame" value="zed2i_left_camera_optical_frame" />
    <param name="world_tf_lookup_timeout_sec" value="0.1" />
  </node>
</launch>
