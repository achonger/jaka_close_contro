<launch>
  <!-- 相机与标签融合自检：按 faces_yaml 对比逐面预测与融合结果 -->

  <arg name="svo_file" default="" />
  <arg name="faces_yaml" default="$(find jaka_close_contro)/config/cube_faces_current.yaml" />
  <arg name="output_csv" default="$(find jaka_close_contro)/config/cube_fusion_debug.csv" />
  <arg name="stats_window" default="0" />
  <arg name="print_rate" default="10.0" />
  <arg name="fused_from_tf" default="false" />
  <arg name="camera_frame" default="" />
  <arg name="fused_pose_topic" default="/cube_center_fused" />
  <arg name="fused_frame" default="cube_center_fused" />

  <!-- 1. ZED2i 相机 -->
  <include file="$(find zed_wrapper)/launch/zed2i.launch">
    <arg name="svo_file" value="$(arg svo_file)" />
  </include>

  <!-- 2. ArUco 检测与分流（与标定流程一致） -->
  <node pkg="jaka_close_contro" type="cube_aruco_detector_node" name="cube_aruco_detector" output="screen">
    <param name="image_topic"       value="/zed2i/zed_node/left/image_rect_color" />
    <param name="camera_info_topic" value="/zed2i/zed_node/left/camera_info" />
    <param name="fiducial_topic"    value="/fiducial_transforms" />
    <param name="default_marker_size" value="0.08" />
    <param name="dictionary" value="DICT_4X4_50" />
    <param name="tool_dictionary" value="DICT_6X6_1000" />
    <param name="tool_marker_length_m" value="0.0425" />
    <param name="tool_marker_separation_m" value="0.005" />
    <param name="min_gridboard_markers" value="2" />
    <param name="world_board_enable" value="true" />
    <param name="world_board_output_id" value="500" />
    <param name="world_board_marker_length_m" value="0.0525" />
    <param name="world_board_marker_separation_m" value="0.005" />
    <param name="world_board_min_markers" value="2" />
    <param name="enable_single_world_markers" value="false" />
    <rosparam param="marker_sizes">
      "0": 0.08
    </rosparam>
    <rosparam param="world_board_marker_ids">[500, 501, 502, 503]</rosparam>
    <rosparam param="tool_gridboards">
      "10": [0, 1, 2, 3]
      "11": [10, 11, 12, 13]
      "12": [20, 21, 22, 23]
      "13": [30, 31, 32, 33]
    </rosparam>
  </node>

  <node pkg="jaka_close_contro" type="fiducial_relay_node" name="fiducial_relay" output="screen">
    <param name="world_id" value="500" />
    <rosparam param="tool_ids">["10", "11", "12", "13"]</rosparam>
    <param name="input_topic" value="/fiducial_transforms" />
    <param name="world_topic" value="/world_fiducials" />
    <param name="tool_topic" value="/tool_fiducials" />
  </node>

  <!-- 3. 多面融合 -->
  <node pkg="jaka_close_contro" type="cube_multi_face_fusion_node" name="cube_multi_face_fusion" output="screen">
    <param name="faces_yaml"           value="$(arg faces_yaml)" />
    <param name="fiducial_topic"       value="/tool_fiducials" />
    <param name="cube_frame"           value="cube_center" />
    <param name="camera_frame_default" value="zed2i_left_camera_optical_frame" />
    <param name="timeout_sec"          value="0.5" />
  </node>

  <!-- 4. 逐面 vs 融合误差计算 -->
  <node pkg="jaka_close_contro" type="cube_fusion_debug_node" name="cube_fusion_debug" output="screen">
    <param name="faces_yaml"      value="$(arg faces_yaml)" />
    <param name="fiducial_topic"  value="/tool_fiducials" />
    <param name="fused_pose_topic" value="$(arg fused_pose_topic)" />
    <param name="camera_frame" value="$(arg camera_frame)" />
    <param name="fused_frame" value="$(arg fused_frame)" />
    <param name="fused_from_tf" value="$(arg fused_from_tf)" />
    <param name="csv_path"      value="$(arg output_csv)" />
    <param name="print_rate"    value="$(arg print_rate)" />
    <param name="stats_window"  value="$(arg stats_window)" />
  </node>

</launch>
